<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>script.aculo.us Unit test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <script src="../lib/prototype.js" type="text/javascript"></script>
  <script src="unittest.js" type="text/javascript"></script>
  <script src="../src/effects.js" type="text/javascript"></script>
  <script src="../src/dragdrop.js" type="text/javascript"></script>
  <script src="../src/controls.js" type="text/javascript"></script>
</head>
<body>
<h1>script.aculo.us Unit test file</h1>
<p>
  Tests for the Ajax.InPlaceEditor.
</p>

<!-- Log output -->
<pre id="testlog"> </pre>

<h1 id="tobeedited">To be edited</h1>

<!-- Tests follow -->
<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[

  // underscores or not?
  Test.Unit.Assertions.prototype.assertEqual = Test.Unit.Assertions.prototype.assert_equal;
  
  Test.Unit.Assertions.prototype.assertHidden = function(element) {
    this.assertEqual("none", element.style.display);
  };

  Test.Unit.Assertions.prototype.assertNotNull = function(object) {
    this.assert(object != null);
  };
  
  Test.Unit.Assertions.prototype.assertNotEqual = function(notExpected, actual) {
    this.assert(!(notExpected == actual));
  };

  Test.Unit.Assertions.prototype.assertNull = Test.Unit.Assertions.prototype.assert_null;

  Test.Unit.Assertions.prototype.assertVisible = function(element) {
    if(element == document) return;
    this.assertNotNull(element);
    if (element.style) {
      // it's not an element, may be a text node for example, just check parent
      this.assertNotEqual("none", element.style.display);
    }
    this.assertVisible(element.parentNode);
  };
  
  Event.simulateEvent = function(element, eventName) {
    var oEvent = document.createEvent("MouseEvents");
    oEvent.initMouseEvent(eventName,true,true,window,1,1,1,1,1,false,false,false,false,0,$(element));
    $(element).dispatchEvent(oEvent);
  };

  new Test.Unit.Runner({

    test_InPlaceEditor: function() { with(this) {
      inPlaceEditor = new Ajax.InPlaceEditor($('tobeedited'), '_inplaceeditor_result.html');

      Event.simulateEvent('tobeedited','mouseover');
      assertEqual("rgb(238, 238, 238)", Element.getStyle('tobeedited','background-color'));

      Event.simulateEvent('tobeedited','mouseout');
      assertEqual("transparent", Element.getStyle('tobeedited','background-color'));

      Event.simulateEvent('tobeedited','mouseover');
      Event.simulateEvent('tobeedited','click');
      assertHidden($('tobeedited'));
      assertNotNull(document.forms[0]);
      assertEqual("cancel", document.forms[0].lastChild.innerHTML);
      assertVisible(document.forms[0]);

      Event.simulateEvent(document.forms[0].lastChild,'click');
      assertNull(document.forms[0]);
      assertVisible($('tobeedited'));
      assertEqual("transparent", Element.getStyle('tobeedited','background-color'));

      Event.simulateEvent('tobeedited','mouseover');
      Event.simulateEvent('tobeedited','click');

      assertEqual("INPUT", document.forms[0].firstChild.tagName);
      assertEqual("To be edited", document.forms[0].firstChild.value);
      assertEqual("INPUT", document.forms[0].childNodes[1].tagName);
      assertEqual("submit", document.forms[0].childNodes[1].type);
      assertEqual("To be edited", document.forms[0].firstChild.value);

      Event.simulateEvent(document.forms[0].childNodes[1],'click');
      assertVisible($('tobeedited'));
      assertEqual("Saving...", $('tobeedited').innerHTML);
      assertEqual("transparent", Element.getStyle('tobeedited','background-color'));

      // TODO doesn't work yet
      setTimeout(function() {
        assertEqual("Server received: To be edited", $('tobeedited').innerHTML);
        assertNull(document.forms[0]);
        assertVisible($('tobeedited'));
        assertEqual("transparent", Element.getStyle('tobeedited','background-color'));
      }, 1000);
    }}
  }, "testlog");
// ]]>
</script>
</body>
</html>